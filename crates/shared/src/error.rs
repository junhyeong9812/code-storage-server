// =============================================================================
// 공통 에러 타입 (error.rs)
// =============================================================================
//
// 애플리케이션 전체에서 사용하는 에러 타입 정의
// thiserror 크레이트를 사용해 보일러플레이트 코드 최소화
//
// 파일 위치: crates/shared/src/error.rs
//
// 사용 예시:
//   use shared::error::AppError;
//   
//   fn find_user(id: &str) -> Result<User, AppError> {
//       Err(AppError::NotFound(format!("User {}", id)))
//   }
// =============================================================================

use thiserror::Error;

// -----------------------------------------------------------------------------
// AppError 열거형 (enum)
// -----------------------------------------------------------------------------
// 
// #[derive(Error, Debug)] 설명:
// - Error: thiserror의 Error trait 자동 구현
//   → std::error::Error trait 구현됨
//   → ? 연산자로 에러 전파 가능
// - Debug: {:?} 포맷으로 출력 가능
//
// #[error("...")] 설명:
// - Display trait 자동 구현
// - {} 포맷으로 출력할 때 이 메시지가 사용됨
// - {0}: 튜플 variant의 첫 번째 필드
// - {name}: named field

/// 애플리케이션 공통 에러
///
/// # 에러 종류
/// - NotFound: 리소스를 찾을 수 없음 (404)
/// - AlreadyExists: 이미 존재함 (409 Conflict)
/// - InvalidInput: 잘못된 입력 (400 Bad Request)
/// - Unauthorized: 인증 필요 (401)
/// - Internal: 내부 서버 에러 (500)
/// - Storage: 저장소 관련 에러
/// - HashMismatch: 해시 불일치 (데이터 무결성 오류)
#[derive(Error, Debug)]
pub enum AppError {
    // -------------------------------------------------------------------------
    // 404 Not Found
    // -------------------------------------------------------------------------
    /// 리소스를 찾을 수 없음
    ///
    /// # Example
    /// ```
    /// AppError::NotFound("User abc123".to_string())
    /// // Display: "Not found: User abc123"
    /// ```
    #[error("Not found: {0}")]
    NotFound(String),  // 튜플 variant: 필드 이름 없이 타입만

    // -------------------------------------------------------------------------
    // 409 Conflict
    // -------------------------------------------------------------------------
    /// 이미 존재하는 리소스
    ///
    /// 예: 같은 이름의 저장소가 이미 있을 때
    #[error("Already exists: {0}")]
    AlreadyExists(String),

    // -------------------------------------------------------------------------
    // 400 Bad Request
    // -------------------------------------------------------------------------
    /// 잘못된 입력
    ///
    /// 예: 유효하지 않은 저장소 이름, 빈 문자열 등
    #[error("Invalid input: {0}")]
    InvalidInput(String),

    // -------------------------------------------------------------------------
    // 401 Unauthorized
    // -------------------------------------------------------------------------
    /// 인증 필요
    ///
    /// 로그인하지 않았거나 토큰이 만료됨
    #[error("Unauthorized")]
    Unauthorized,  // 유닛 variant: 필드 없음

    // -------------------------------------------------------------------------
    // 500 Internal Server Error
    // -------------------------------------------------------------------------
    /// 내부 서버 에러
    ///
    /// 예상치 못한 에러, 버그 등
    #[error("Internal error: {0}")]
    Internal(String),

    // -------------------------------------------------------------------------
    // Storage 관련
    // -------------------------------------------------------------------------
    /// 저장소 에러
    ///
    /// 파일 시스템, DB 접근 실패 등
    #[error("Storage error: {0}")]
    Storage(String),

    // -------------------------------------------------------------------------
    // 데이터 무결성
    // -------------------------------------------------------------------------
    /// 해시 불일치
    ///
    /// Blob 다운로드 후 해시 검증 실패 등
    /// 데이터가 손상되었거나 변조됨
    ///
    /// # Example
    /// ```
    /// AppError::HashMismatch {
    ///     expected: "abc123".to_string(),
    ///     actual: "def456".to_string(),
    /// }
    /// // Display: "Hash mismatch: expected abc123, got def456"
    /// ```
    #[error("Hash mismatch: expected {expected}, got {actual}")]
    HashMismatch {  // 구조체 variant: named fields
        expected: String,
        actual: String,
    },
}

// =============================================================================
// From 트레이트 구현 (에러 변환)
// =============================================================================
// 다른 에러 타입을 AppError로 자동 변환
// ? 연산자 사용 시 자동으로 호출됨
//
// 예시:
//   let file = std::fs::read("file.txt")?;  
//   // std::io::Error → AppError::Storage 자동 변환

// 주석 처리: 필요할 때 활성화
// impl From<std::io::Error> for AppError {
//     fn from(err: std::io::Error) -> Self {
//         AppError::Storage(err.to_string())
//     }
// }
//
// impl From<sqlx::Error> for AppError {
//     fn from(err: sqlx::Error) -> Self {
//         AppError::Internal(err.to_string())
//     }
// }